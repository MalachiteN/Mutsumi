# Notebook æ¨¡å—

## 1. æ¨¡å—åç§°ä¸å®šä½

**Notebook æ¨¡å—æ˜¯ Mutsumi çš„æ ¸å¿ƒæ•°æ®å±‚ï¼Œè´Ÿè´£ Notebook çš„æŒä¹…åŒ–å­˜å‚¨ã€ä¸Šä¸‹æ–‡å¼•ç”¨è§£æå’Œç¼–è¾‘ä½“éªŒå¢å¼ºã€‚**

è¯¥æ¨¡å—ä½œä¸º VSCode Notebook API ä¸ Mutsumi å†…éƒ¨æ•°æ®æ¨¡å‹ä¹‹é—´çš„æ¡¥æ¢ï¼Œå®ç°äº†ä»¥ä¸‹æ ¸å¿ƒèƒ½åŠ›ï¼š
- å°† Notebook åºåˆ—åŒ–ä¸ºå¯è¯»çš„ Markdown/JSON æ··åˆæ ¼å¼
- è§£æ `@[]` è¯­æ³•å®ç°æ–‡ä»¶ä¸Šä¸‹æ–‡æ³¨å…¥
- æä¾›æ™ºèƒ½çš„æ–‡ä»¶è·¯å¾„è‡ªåŠ¨å®ŒæˆåŠŸèƒ½

---

## 2. æ–‡ä»¶ç»„æˆä¸èŒè´£

### 2.1 serializer.ts

**æ–‡ä»¶ä½ç½®**: `src/notebook/serializer.ts`  
**å¯¼å‡ºç±»**: `MutsumiSerializer`

å®ç° VSCode `NotebookSerializer` æ¥å£ï¼Œè´Ÿè´£ Notebook çš„ä¿å­˜ä¸åŠ è½½ã€‚

| æ–¹æ³• | èŒè´£ |
|------|------|
| `deserializeNotebook()` | å°†ç£ç›˜ä¸Šçš„ JSON å†…å®¹è§£æä¸º VSCode NotebookData å¯¹è±¡ |
| `serializeNotebook()` | å°† VSCode NotebookData åºåˆ—åŒ–ä¸º JSON æ ¼å¼ä¿å­˜ |
| `renderInteractionToMarkdown()` | å°†åŠ©æ‰‹/å·¥å…·çš„äº¤äº’æ¶ˆæ¯æ¸²æŸ“ä¸º Markdown æ ¼å¼ç”¨äºæ˜¾ç¤º |
| `createDefaultContent()` | åˆ›å»ºé»˜è®¤çš„ç©ºç™½ Notebook å†…å®¹ï¼ˆé™æ€æ–¹æ³•ï¼‰ |

**æ ¸å¿ƒè®¾è®¡è¦ç‚¹**:
- ç”¨æˆ·æ¶ˆæ¯ â†’ `Code Cell`ï¼ˆå¯æ‰§è¡Œï¼‰
- ç³»ç»Ÿæ¶ˆæ¯ â†’ `Markup Cell`ï¼ˆä»…æ˜¾ç¤ºï¼‰
- åŠ©æ‰‹/å·¥å…·æ¶ˆæ¯ â†’ æ¸²æŸ“ä¸º Markdown å†…å®¹ï¼Œæ˜¾ç¤ºåœ¨ `Markup Cell` ä¸­
- ä½¿ç”¨ `mutsumi_interaction` å…ƒæ•°æ®ä¿å­˜å®Œæ•´çš„äº¤äº’å†å²

### 2.2 contextResolver.ts

**æ–‡ä»¶ä½ç½®**: `src/notebook/contextResolver.ts`  
**å¯¼å‡ºç±»**: `ContextResolver`

è§£æç”¨æˆ·è¾“å…¥ä¸­çš„ `@[]` å¼•ç”¨è¯­æ³•ï¼Œå°†æ–‡ä»¶/ç›®å½•å†…å®¹æ³¨å…¥åˆ°å¯¹è¯ä¸Šä¸‹æ–‡ã€‚

| æ–¹æ³• | èŒè´£ |
|------|------|
| `resolveReferencesInText()` | ä¸»å…¥å£ï¼šæ‰«ææ–‡æœ¬ä¸­çš„å¼•ç”¨å¹¶è§£æä¸ºæ³¨å…¥å†…å®¹ |
| `parseReference()` | è§£æå¼•ç”¨è¯­æ³• `@[]` æå–è·¯å¾„å’Œè¡Œå·èŒƒå›´ |
| `readResource()` | è¯»å–æ–‡ä»¶å†…å®¹æˆ–åˆ—å‡ºç›®å½•å†…å®¹ |

**æ”¯æŒçš„å¼•ç”¨æ ¼å¼**:
| è¯­æ³• | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `@[path]` | å¼•ç”¨æ•´ä¸ªæ–‡ä»¶ | `@[src/main.ts]` |
| `@[path:start]` | å¼•ç”¨æŒ‡å®šè¡Œ | `@[src/main.ts:10]` |
| `@[path:start:end]` | å¼•ç”¨è¡ŒèŒƒå›´ | `@[src/main.ts:10:20]` |

### 2.3 completionProvider.ts

**æ–‡ä»¶ä½ç½®**: `src/notebook/completionProvider.ts`  
**å¯¼å‡ºç±»**: `ReferenceCompletionProvider`

ä¸º `@[]` è¯­æ³•æä¾›æ–‡ä»¶è·¯å¾„è‡ªåŠ¨å®ŒæˆåŠŸèƒ½ã€‚

| æ–¹æ³• | èŒè´£ |
|------|------|
| `provideCompletionItems()` | åœ¨ `@` å­—ç¬¦åè§¦å‘ï¼Œæä¾›æ–‡ä»¶å’Œç›®å½•å»ºè®® |

**åŠŸèƒ½ç‰¹æ€§**:
- è‡ªåŠ¨è§¦å‘ï¼šå½“ç”¨æˆ·åœ¨è¡Œå°¾è¾“å…¥ `@` æ—¶æ¿€æ´»
- æ–‡ä»¶å»ºè®®ï¼šä½¿ç”¨ `vscode.workspace.findFiles()` æ‰«æå·¥ä½œåŒºæ–‡ä»¶ï¼ˆè‡ªåŠ¨éµå¾ª `.gitignore`ï¼‰
- ç›®å½•å»ºè®®ï¼šä½¿ç”¨ `vscode.workspace.fs.readDirectory()` è·å–é¡¶å±‚ç›®å½•
- æ’åºç­–ç•¥ï¼šæ–‡ä»¶ä¼˜å…ˆï¼ˆ`000_` å‰ç¼€ï¼‰ï¼Œç›®å½•æ¬¡ä¹‹ï¼ˆ`001_` å‰ç¼€ï¼‰
- æ’å…¥æ ¼å¼ï¼šè‡ªåŠ¨è¡¥å…¨ä¸º `@[path]` æ ¼å¼

---

## 3. å¼•ç”¨ç³»ç»Ÿ

### 3.1 å¼•ç”¨è¯­æ³•è§£ææµç¨‹

```
ç”¨æˆ·è¾“å…¥: "è¯·åˆ†æ @[src/main.ts:10:20] ä¸­çš„ä»£ç "
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: æ­£åˆ™åŒ¹é…                                             â”‚
â”‚  REF_REGEX = /@\[([a-zA-Z0-9_\-\/\.\\\:]+)\]/g              â”‚
â”‚  æ•è·ç»„: "src/main.ts:10:20"                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: è§£æå¼•ç”¨å‚æ•°                                         â”‚
â”‚  parseReference("src/main.ts:10:20")                          â”‚
â”‚  â”œâ”€â”€ filePath: "src/main.ts"                                  â”‚
â”‚  â”œâ”€â”€ startLine: 10 (1-based)                                  â”‚
â”‚  â””â”€â”€ endLine: 20 (1-based, å¯é€‰)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: æ„é€  URI                                             â”‚
â”‚  â”œâ”€â”€ å« "://" â†’ vscode.Uri.parse() (URI Scheme)              â”‚
â”‚  â””â”€â”€ æ™®é€šè·¯å¾„ â†’ path.join(root, filePath) â†’ vscode.Uri.file() â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: è¯»å–èµ„æº                                             â”‚
â”‚  readResource(uri, start, end)                                â”‚
â”‚  â”œâ”€â”€ ç›®å½• â†’ readDirectory() â†’ åˆ—å‡º [DIR]/[FILE] æ¡ç›®         â”‚
â”‚  â””â”€â”€ æ–‡ä»¶ â†’ readFile() â†’ æŒ‰éœ€åˆ‡ç‰‡è¡ŒèŒƒå›´                      â”‚
â”‚      â”œâ”€â”€ æ— è¡Œå· â†’ è¿”å›å®Œæ•´å†…å®¹                                â”‚
â”‚      â””â”€â”€ æœ‰è¡Œå· â†’ split('\n').slice(start-1, end).join()     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 5: æ ¼å¼åŒ–è¾“å‡º                                           â”‚
â”‚  ### User Provided Context References:                        â”‚
â”‚  #### Source: src/main.ts:10:20                               â”‚
â”‚  ```                                                          â”‚
â”‚  <æ–‡ä»¶å†…å®¹æˆ–ç›®å½•åˆ—è¡¨>                                          â”‚
â”‚  ```                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 é”™è¯¯å¤„ç†

å½“å¼•ç”¨è§£æå¤±è´¥æ—¶ï¼Œç³»ç»Ÿä¼šç”Ÿæˆé”™è¯¯ä¿¡æ¯è€Œéä¸­æ–­æµç¨‹ï¼š

```markdown
#### Source: nonexistent.ts
> Error reading reference: ENOENT: no such file or directory...
```

è¿™ç¡®ä¿äº†å³ä½¿æŸäº›å¼•ç”¨æ— æ•ˆï¼Œå…¶ä»–æœ‰æ•ˆå¼•ç”¨ä»èƒ½è¢«æ­£ç¡®å¤„ç†ã€‚

---

## 4. åºåˆ—åŒ–æ ¼å¼

### 4.1 æ–‡ä»¶æ ¼å¼

Notebook æ–‡ä»¶ä»¥ JSON æ ¼å¼å­˜å‚¨ï¼Œæ‰©å±•åä¸º `.mutsumi`ï¼Œå†…éƒ¨ç»“æ„å¦‚ä¸‹ï¼š

```json
{
  "metadata": {
    "uuid": "550e8400-e29b-41d4-a716-446655440000",
    "name": "Code Review Agent",
    "created_at": "2024-01-15T08:30:00.000Z",
    "parent_agent_id": null,
    "allowed_uris": ["/workspace/project-a"]
  },
  "context": [
    { "role": "system", "content": "You are a helpful coding assistant." },
    { "role": "user", "content": "Review this file: @[src/main.ts]" },
    { "role": "assistant", "content": "I'll analyze the file..." },
    { "role": "tool", "name": "read_file", "content": "..." }
  ]
}
```

### 4.2 VSCode NotebookData æ˜ å°„

| JSON ç»“æ„ | VSCode å¯¹è±¡ | Cell ç±»å‹ | è¯´æ˜ |
|-----------|-------------|-----------|------|
| `role: "user"` | `NotebookCellData` | `Code` (å¯æ‰§è¡Œ) | ç”¨æˆ·è¾“å…¥ |
| `role: "system"` | `NotebookCellData` | `Markup` (åªè¯») | ç³»ç»Ÿæç¤º |
| `role: "assistant"` | `NotebookCellData` | `Markup` | AI å›å¤ |
| åŠ©æ‰‹æ¶ˆæ¯ç»„ | `NotebookCellOutput` | Markdown è¾“å‡º | æ˜¾ç¤ºäº¤äº’ç»“æœ |

### 4.3 æ¸²æŸ“è§„åˆ™

åŠ©æ‰‹/å·¥å…·æ¶ˆæ¯çš„ Markdown æ¸²æŸ“é‡‡ç”¨ä»¥ä¸‹æ ¼å¼ï¼š

```markdown
<!-- æ¨ç†å†…å®¹ -->
<details><summary>ğŸ’­ Thinking Process</summary>
<reasoning_content>
</details>

<!-- ä¸»è¦å†…å®¹ -->
<assistant_content>

<!-- å·¥å…·è°ƒç”¨ -->
> ğŸ”§ **Call**: `tool_name`

<!-- å·¥å…·ç»“æœ -->
<details><summary>ğŸ“ Result: tool_name</summary>
```
<truncated_content>
```
</details>
```

### 4.4 åºåˆ—åŒ–æ³¨æ„äº‹é¡¹

**ååºåˆ—åŒ– â†’ åºåˆ—åŒ–ä¸€è‡´æ€§**:
1. ç”¨æˆ· Cell çš„ `mutsumi_interaction` å…ƒæ•°æ®ä¿å­˜å…³è”çš„åŠ©æ‰‹/å·¥å…·æ¶ˆæ¯
2. åºåˆ—åŒ–æ—¶ä»å…ƒæ•°æ®æ¢å¤å®Œæ•´å¯¹è¯å†å²
3. çº¯ Markup Cellï¼ˆä»æ–‡ä»¶åŠ è½½çš„ï¼‰ä¼˜å…ˆä½¿ç”¨å…ƒæ•°æ®ä¸­çš„åŸå§‹æ¶ˆæ¯

---

## 5. æ¨¡å—è¾¹ç•Œ

### 5.1 ä¸ VSCode Notebook API çš„é›†æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VSCode Extension Host                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              VSCode Notebook API                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ Content     â”‚  â”‚ Serializer  â”‚  â”‚ Execution      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ Provider    â”‚  â”‚ Interface   â”‚  â”‚ Engine         â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â”‚                â”‚                               â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•§â•â•â•â•â•â•â•â•â•â•â•â•â•—                  â”‚
â”‚  â•‘        Mutsumi Notebook Module         â•‘                  â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘                  â”‚
â”‚  â•‘  â”‚ MutsumiSerializer               â”‚â—„â”€â”€â•«â”€â”€ deserialize/   â”‚
â”‚  â•‘  â”‚ - implements NotebookSerializer â”‚   â•‘    serialize     â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘                  â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘                  â”‚
â”‚  â•‘  â”‚ ContextResolver                 â”‚   â•‘                  â”‚
â”‚  â•‘  â”‚ - resolveReferencesInText()     â”‚   â•‘                  â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘                  â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘                  â”‚
â”‚  â•‘  â”‚ ReferenceCompletionProvider     â”‚â—„â”€â”€â•«â”€â”€ register as    â”‚
â”‚  â•‘  â”‚ - implements CompletionItemProv â”‚   â•‘    provider      â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘                  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 æ³¨å†Œæ–¹å¼

åœ¨ `extension.ts` ä¸­çš„æ³¨å†Œç¤ºä¾‹ï¼š

```typescript
// æ³¨å†Œ Notebook Serializer
context.subscriptions.push(
    vscode.workspace.registerNotebookSerializer(
        'mutsumi-notebook', 
        new MutsumiSerializer()
    )
);

// æ³¨å†Œè‡ªåŠ¨å®Œæˆæä¾›è€…
context.subscriptions.push(
    vscode.languages.registerCompletionItemProvider(
        { language: 'markdown', notebookType: 'mutsumi-notebook' },
        new ReferenceCompletionProvider(),
        '@'  // è§¦å‘å­—ç¬¦
    )
);
```

### 5.3 æ¨¡å—è¾¹ç•Œè¯´æ˜

| èŒè´£ | åœ¨æœ¬æ¨¡å— | åœ¨è°ƒç”¨æ–¹ |
|------|----------|----------|
| Notebook æ–‡ä»¶è¯»å†™ | âœ… Serializer | âŒ |
| Cell æ‰§è¡Œ | âŒ | âœ… Controller |
| å¼•ç”¨è§£æ | âœ… ContextResolver | âŒ |
| æ–‡ä»¶é€‰æ‹©å™¨ UI | âŒ | âœ… Command |
| è‡ªåŠ¨å®Œæˆ | âœ… CompletionProvider | âŒ |
| LLM è°ƒç”¨ | âŒ | âœ… Controller |

---

## 6. ç±»å‹å®šä¹‰

### 6.1 å†…éƒ¨ä½¿ç”¨çš„æ ¸å¿ƒç±»å‹

```typescript
// types.ts ä¸­å®šä¹‰çš„æ ¸å¿ƒç±»å‹
interface AgentMetadata {
    uuid: string;
    name: string;
    created_at: string;
    parent_agent_id: string | null;
    allowed_uris: string[];
}

interface AgentMessage {
    role: 'system' | 'user' | 'assistant' | 'tool';
    content?: string;
    reasoning_content?: string;    // æ¨ç†å†…å®¹ï¼ˆå¦‚ DeepSeek R1ï¼‰
    tool_calls?: ToolCall[];        // åŠ©æ‰‹å‘èµ·çš„å·¥å…·è°ƒç”¨
    name?: string;                  // å·¥å…·åç§°ï¼ˆrole='tool' æ—¶ï¼‰
}

interface AgentContext {
    metadata: AgentMetadata;
    context: AgentMessage[];
}

// contextResolver.ts ä¸­å®šä¹‰
interface ResolvedContext {
    originalRef: string;
    content: string;
    type: 'file' | 'directory' | 'error';
}
```

---

## 7. æ‰©å±•æŒ‡å—

### 7.1 æ·»åŠ æ–°çš„å¼•ç”¨è¯­æ³•

å¦‚éœ€æ”¯æŒæ›´å¤æ‚çš„å¼•ç”¨æ ¼å¼ï¼ˆå¦‚ Git commit å¼•ç”¨ï¼‰ï¼š

1. åœ¨ `ContextResolver.REF_REGEX` ä¸­æ‰©å±•æ­£åˆ™è¡¨è¾¾å¼
2. åœ¨ `parseReference()` ä¸­å¤„ç†æ–°çš„è¯­æ³•æ ¼å¼
3. åœ¨ `readResource()` ä¸­æ·»åŠ å¯¹åº”çš„è¯»å–é€»è¾‘

### 7.2 è‡ªå®šä¹‰æ¸²æŸ“æ ¼å¼

ä¿®æ”¹ `renderInteractionToMarkdown()` å¯è°ƒæ•´ Cell Output çš„æ˜¾ç¤ºæ ·å¼ï¼š
- æ·»åŠ æ–°çš„æ¶ˆæ¯ç±»å‹å¤„ç†
- è‡ªå®šä¹‰æŠ˜å /å±•å¼€è¡Œä¸º
- è°ƒæ•´å›¾æ ‡å’Œé¢œè‰²

---

*æ–‡æ¡£ç‰ˆæœ¬: 1.0*  
*æœ€åæ›´æ–°: 2024å¹´*
