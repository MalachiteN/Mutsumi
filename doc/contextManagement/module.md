# contextManagement 模块文档

---

## 1. 模块名称与定位

**contextManagement** 是 Mutsumi 的核心上下文管理模块，负责 Agent 系统提示词（System Prompt）的组装与交互历史的格式化处理，为 LLM 提供完整的对话上下文。

---

## 2. 文件组成与职责

| 文件 | 核心职责 | 导出函数 |
|------|---------|---------|
| `prompts.ts` | 系统提示词组装 | `initializeRules()`, `getSystemPrompt()` |
| `history.ts` | 交互历史构建 | `buildInteractionHistory()` |

### 2.1 prompts.ts

负责 Mutsumi Agent 的系统提示词构建，将各类规则、能力说明、操作规范组装成结构化的系统提示词。

**主要函数：**

```typescript
/**
 * 初始化规则目录
 * 从插件 assets 复制默认规则文件到工作空间
 */
function initializeRules(
  extensionUri: vscode.Uri, 
  workspaceUri: vscode.Uri
): Promise<void>

/**
 * 获取完整的系统提示词
 * 动态加载规则文件并附加运行时上下文
 */
function getSystemPrompt(
  workspaceUri: vscode.Uri, 
  allowedUris: string[], 
  isSubAgent: boolean
): Promise<string>
```

### 2.2 history.ts

负责将 Agent 执行历史转换为 LLM 可消费的对话格式，管理对话状态。

**主要函数：**

```typescript
/**
 * 构建交互历史
 * 将执行历史转换为标准对话格式（OpenAI格式）
 */
function buildInteractionHistory(
  executions: AgentExecution[],
  currentInput: string
): ChatMessage[]
```

---

## 3. 提示词架构

系统提示词采用分层架构设计，由以下核心部分组成：

```
┌─────────────────────────────────────────────────────────────┐
│                    System Prompt 结构                        │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 1. 角色定义 (Role Definition)                         │   │
│  │    - Agent 身份定位                                    │   │
│  │    - 核心使命声明                                      │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 2. 能力概览 (Capabilities)                            │   │
│  │    - 文件操作能力                                      │   │
│  │    - 搜索与导航能力                                    │   │
│  │    - 系统执行能力                                      │   │
│  │    - 并行能力与诊断能力                                │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 3. 操作规范 (Operating Rules)                         │   │
│  │    - 系统信息优先原则                                  │   │
│  │    - 智能文件读取策略                                  │   │
│  │    - 级联 Fork 谨慎原则                                │   │
│  │    - Shell 选择规范                                    │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 4. 禁止事项 (Prohibitions)                            │   │
│  │    - 严禁跳过前置检查                                  │   │
│  │    - 严禁滥用 fork                                    │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 5. 沟通风格 (Communication Style)                     │   │
│  │    - 简洁高效、结果导向                                │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 3.1 角色定义

定义 Agent 的核心身份：

> 你是 Mutsumi，一名 AI 编程助手。你的核心使命是：
> - **理解用户意图**：准确解读用户的编程需求
> - **自主规划执行**：独立分析任务并制定执行策略
> - **交付完整方案**：提供可运行的代码和清晰的实现思路

### 3.2 能力概览

| 能力类别 | 说明 |
|---------|------|
| 文件操作 | 读取、创建、修改、删除文件和目录 |
| 搜索导航 | 内容搜索、文件名搜索、目录浏览 |
| 系统执行 | Shell 命令、Git 操作、环境感知 |
| 并行能力 | 通过 `self_fork` 创建子 Agent |
| 诊断调试 | 获取警告和错误信息 |

### 3.3 操作规范

**规范一：系统信息优先原则**
- 执行 shell 命令前必须先执行 `system_info`
- 确定操作系统类型、可用 shell 路径、包管理器

**规范二：智能文件读取策略**
- 读取文件前必须先执行 `get_file_size`
- 小文件 (< 50 KB)：全文读取
- 中等文件 (50-500 KB)：按需读取
- 大文件 (> 500 KB)：优先搜索和上下文读取

**规范三：级联 Fork 谨慎原则**
- 默认策略：优先独立完成
- 仅在任务规模过大、必须拆分时才使用 `self_fork`

**规范四：Shell 选择规范**
| 平台 | 首选 Shell |
|------|-----------|
| Linux | bash |
| macOS | bash |
| Windows | PowerShell |

### 3.4 禁止事项

| 禁止行为 | 说明 |
|---------|------|
| 永不跳过前置检查 | 执行 shell 命令前严禁跳过 `system_info`；读取文件前严禁跳过 `get_file_size` |
| 永不滥用 fork | 不要为简单任务级联 fork；不要为了"方便"而拆分本可独立完成的任务 |

### 3.5 沟通风格

- **简洁高效**：直接报告执行结果，不需要解释架构决策
- **结果导向**：清晰汇报完成状态和关键结果
- **主动反馈**：如遇阻碍或意外情况，主动说明

---

## 4. 模块边界

### 4.1 与 agentRunner 的协作关系

```
┌──────────────────────────────────────────────────────────────┐
│                        Agent Runner                          │
│  ┌────────────────────────────────────────────────────────┐  │
│  │  1. 接收用户输入                                       │  │
│  │  2. 调用 contextManagement.getSystemPrompt()          │  │
│  │  3. 调用 contextManagement.buildInteractionHistory()  │  │
│  │  4. 组装完整请求发送给 LLM                             │  │
│  │  5. 接收 LLM 响应并执行工具调用                        │  │
│  │  6. 记录执行历史                                       │  │
│  └────────────────────────────────────────────────────────┘  │
│                              │                               │
│                              ▼                               │
│  ┌────────────────────────────────────────────────────────┐  │
│  │              contextManagement 模块                     │  │
│  │  ┌──────────────┐        ┌──────────────────┐         │  │
│  │  │  prompts.ts  │        │    history.ts    │         │  │
│  │  │              │        │                  │         │  │
│  │  │ - 组装系统   │        │ - 构建对话历史   │         │  │
│  │  │   提示词     │        │ - 格式转换       │         │  │
│  │  │ - 规则管理   │        │ - 状态管理       │         │  │
│  │  └──────────────┘        └──────────────────┘         │  │
│  └────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘
```

### 4.2 职责边界

| 模块 | 职责范围 | 不处理的内容 |
|------|---------|-------------|
| **contextManagement** | 提示词组装、历史格式化 | LLM 通信、工具执行、流程控制 |
| **agentRunner** | 任务调度、LLM 通信、工具执行 | 提示词内容、历史存储格式 |

### 4.3 数据流向

```
┌─────────────┐      ┌──────────────────┐      ┌─────────────┐
│  规则文件   │ ───▶ │   prompts.ts     │ ───▶ │ 系统提示词  │
│ (*.md)      │      │                  │      │ (string)    │
└─────────────┘      └──────────────────┘      └──────┬──────┘
                                                      │
                                                      ▼
┌─────────────┐      ┌──────────────────┐      ┌─────────────┐
│ 执行历史    │ ───▶ │   history.ts     │ ───▶ │ 对话消息    │
│ (raw data)  │      │                  │      │ (ChatMsg[]) │
└─────────────┘      └──────────────────┘      └─────────────┘
                                                      │
                                                      ▼
                                              ┌─────────────┐
                                              │   LLM API   │
                                              │   Request   │
                                              └─────────────┘
```

### 4.4 接口契约

**contextManagement 向 agentRunner 提供：**

1. **System Prompt** (`string`)
   - 完成组装的系统提示词文本
   - 可直接用于 LLM 请求的 `system` 角色消息

2. **Interaction History** (`ChatMessage[]`)
   - 符合 OpenAI Chat API 格式的消息数组
   - 包含用户输入、Agent 思考、工具调用和结果

**contextManagement 接收的外部输入：**

1. **规则文件路径** - 用于加载操作规范
2. **执行历史记录** - 原始执行数据用于格式化
3. **当前用户输入** - 需要追加到对话历史

---

## 5. 扩展性设计

### 5.1 规则热更新

`initializeRules()` 支持从文件系统动态加载规则文件，允许：
- 规则更新无需重启
- 多语言规则支持（通过文件命名区分）
- 规则模块化拆分

### 5.2 历史存储策略

`buildInteractionHistory()` 支持多种存储后端：
- 内存存储（默认，开发调试）
- 文件存储（持久化）
- 数据库存储（大规模部署）

### 5.3 提示词版本管理

通过提示词模板版本标识，支持：
- A/B 测试不同提示词策略
- 渐进式提示词升级
- 回滚机制

---

## 6. 相关文档

- [prompts.ts 详细说明](./prompts.md)
- [history.ts 详细说明](./history.md)
